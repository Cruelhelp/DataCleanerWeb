<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Document Cleaner with Pyodide</title>
    <!--
      This HTML document demonstrates how to wrap Python code in a browser using
      Pyodide.  The interface is similar to the previous VS Code‑inspired
      cleaners, but instead of relying on SheetJS alone to process data,
      selected rows are passed to a Python script (running in WebAssembly)
      which performs the grouping and deduplication using pandas.  Because
      Pyodide runs inside the browser, we expose controls that let the user
      choose which records to process to avoid loading the entire workbook into
      memory at once.  A simple compression step uses JSZip to pack the
      cleaned Excel file into a zip archive for download.
    -->
    <style>
      /* VS Code–inspired dark theme */
      :root {
        --bg: #1e1e1e;
        --bg2: #252526;
        --bg3: #2d2d2d;
        --fg: #d4d4d4;
        --accent: #007acc;
        --btn: #0e639c;
        --btn-hover: #1177bb;
        --btn-press: #094771;
        --muted: #8a8a8a;
        --border: #2d2d2d;
        --danger: #f14c4c;
        --radius: 6px;
        --font-body: "Segoe UI", "Arial", "Helvetica Neue", Helvetica, sans-serif;
        --font-display: "Segoe UI", "Arial", "Helvetica Neue", Helvetica, sans-serif;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: var(--font-body);
        overflow: hidden;
      }
      /* Top menubar with tabs */
      .menubar {
        height: 40px;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 12px;
      }
      .menu-item {
        padding: 6px 8px;
        border-radius: 4px;
        cursor: pointer;
        color: var(--fg);
        font-size: 13px;
      }
      .menu-item.active {
        background: var(--bg3);
      }
      .app {
        position: absolute;
        top: 40px;
        bottom: 26px;
        left: 0;
        right: 0;
        display: flex;
        min-height: 0;
      }
      .sidebar {
        width: 300px;
        background: var(--bg2);
        border-right: 1px solid var(--border);
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        overflow-y: auto;
      }
      .sidebar h2 {
        margin: 0;
        font-size: 12px;
        color: #bbbbbb;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .sidebar input[type="text"], .sidebar select, .sidebar button {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg3);
        color: var(--fg);
      }
      .sidebar button {
        background: var(--btn);
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .sidebar button:hover { background: var(--btn-hover); }
      .sidebar button:active { background: var(--btn-press); }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .main-header {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        background: var(--bg2);
      }
      .main-header h1 {
        margin: 0;
        font-size: 20px;
        color: #ffffff;
      }
      .statusbar {
        height: 26px;
        background: var(--accent);
        color: #ffffff;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        padding: 0 12px;
        font-size: 12px;
      }
      .panel {
        padding: 16px;
        flex: 1;
        overflow-y: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid var(--border);
      }
      th {
        position: sticky;
        top: 0;
        background: var(--bg2);
      }
      /* A simple search input in main area */
      .search-bar {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
      }
      .search-bar input {
        flex: 1;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg3);
        color: var(--fg);
      }
      .search-bar button {
        padding: 8px 12px;
        border: none;
        border-radius: var(--radius);
        background: var(--btn);
        color: #fff;
        cursor: pointer;
      }
    </style>
    <!-- SheetJS for Excel parsing/writing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- JSZip for compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- Pyodide for running Python in the browser -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  </head>
  <body>
    <!-- Top menu bar -->
    <div class="menubar">
      <div id="tab-cleaner" class="menu-item active" onclick="showTab('cleaner')">Cleaner</div>
      <div id="tab-about" class="menu-item" onclick="showTab('about')">About</div>
    </div>
    <!-- Main application container -->
    <div class="app">
      <!-- Sidebar for controls -->
      <div class="sidebar" id="sidebar">
        <h2>Upload File</h2>
        <input type="file" id="file-input" accept=".xlsx,.xls,.csv" />
        <button id="scan-btn" onclick="scanItems()">Scan Items</button>
        <h2>Item Filter</h2>
        <input type="text" id="item-search" placeholder="Search item numbers" oninput="filterItemList()" />
        <select id="item-list" multiple size="10" style="height: 200px;"></select>
        <button id="clean-btn" onclick="cleanSelected()">Clean Selected</button>
        <button id="download-btn" onclick="downloadCleaned()" disabled>Download Cleaned (zip)</button>
      </div>
      <!-- Main area containing either the cleaner UI or the about text -->
      <div class="main" id="main">
        <!-- Cleaner content -->
        <div id="cleaner" class="panel">
          <div class="main-header">
            <h1>Interactive Cleaner (Pyodide)</h1>
          </div>
          <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search cleaned data" oninput="filterResults()" />
          </div>
          <div style="overflow-y:auto; max-height: calc(100vh - 200px);">
            <table id="results-table">
              <thead>
                <tr id="results-header"></tr>
              </thead>
              <tbody id="results-body"></tbody>
            </table>
          </div>
        </div>
        <!-- About content -->
        <div id="about" class="panel" style="display:none;">
          <div class="main-header">
            <h1>About this Tool</h1>
          </div>
          <p>This data cleaner combines the functionality of a grouping tool and a manual trimming
             tool into a single interface.  It uses the Pyodide project to run
             Python in the browser, allowing the same pandas logic used on the
             server to run client‑side.  After you upload an Excel or CSV file,
             the <em>Scan Items</em> button will analyse the file and present a list of item
             numbers.  You can select the items you care about, and only those
             records will be passed into the Python runtime for cleaning.
          </p>
          <p>By choosing specific items instead of processing the entire export,
             you avoid exhausting the browser’s memory.  The cleaned records are
             grouped by item number, document name, document type group, date stored
             and document type, and all file paths are consolidated.  The results
             appear in the table on the Cleaner tab and may be downloaded as a
             compressed Excel file.</p>
          <p>This client‑side approach removes the need for a separate grouping app or
             manual cleanup—everything runs in your browser.  However, be aware
             that browsers impose strict memory limits【79604301145918†L152-L155】, so
             processing very large datasets can still be slow or may fail.  When
             dealing with heavy workloads, we recommend running the cleaning
             script in a desktop environment instead.</p>
        </div>
      </div>
    </div>
    <!-- Status bar -->
    <div class="statusbar" id="statusbar">Ready</div>
    <script>
      // Global state
      let pyodideReady = false;
      let pyodideInstance = null;
      let cleanedData = [];
      let fullFileBuffer = null;
      let uniqueItems = [];
      // Show appropriate tab
      function showTab(tab) {
        document.getElementById('tab-cleaner').classList.remove('active');
        document.getElementById('tab-about').classList.remove('active');
        document.getElementById('cleaner').style.display = 'none';
        document.getElementById('about').style.display = 'none';
        if (tab === 'cleaner') {
          document.getElementById('tab-cleaner').classList.add('active');
          document.getElementById('cleaner').style.display = 'block';
        } else {
          document.getElementById('tab-about').classList.add('active');
          document.getElementById('about').style.display = 'block';
        }
      }
      // Update status bar
      function updateStatus(text) {
        document.getElementById('statusbar').textContent = text;
      }
      // Lazy-load Pyodide and required packages
      async function ensurePyodide() {
        if (pyodideReady) return;
        updateStatus('Loading Pyodide…');
        pyodideInstance = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/' });
        updateStatus('Installing pandas and openpyxl…');
        await pyodideInstance.loadPackage(['pandas', 'openpyxl']);
        pyodideReady = true;
        updateStatus('Pyodide ready');
      }
      // Scan uploaded file for unique item numbers
      async function scanItems() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (!file) {
          alert('Please select a file');
          return;
        }
        updateStatus('Reading file…');
        // Read file as ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();
        fullFileBuffer = new Uint8Array(arrayBuffer);
        updateStatus('Parsing workbook…');
        try {
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];
          // Get rows as 2D array (no headers) to minimise memory usage
          const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
          // find index of item number column heuristically: assume column with numeric or string values that appear in header or row0
          let colIndex = 0;
          // search header row for 'Item No'
          if (data.length > 0) {
            for (let i = 0; i < data[0].length; i++) {
              const cell = (data[0][i] || '').toString().toLowerCase();
              if (cell.includes('item') && cell.includes('no')) {
                colIndex = i;
                break;
              }
            }
          }
          const set = new Set();
          // skip header row
          for (let i = 1; i < data.length; i++) {
            const val = data[i][colIndex];
            if (val !== undefined && val !== null && val.toString().trim() !== '') {
              set.add(val.toString().trim());
            }
          }
          uniqueItems = Array.from(set).sort();
          renderItemList(uniqueItems);
          updateStatus('Found ' + uniqueItems.length + ' unique items');
        } catch (e) {
          console.error(e);
          updateStatus('Error reading file');
        }
      }
      // Render item list into the select element
      function renderItemList(items) {
        const listEl = document.getElementById('item-list');
        listEl.innerHTML = '';
        for (const item of items) {
          const option = document.createElement('option');
          option.value = item;
          option.textContent = item;
          listEl.appendChild(option);
        }
      }
      // Filter item list based on search input
      function filterItemList() {
        const query = document.getElementById('item-search').value.toLowerCase();
        const filtered = uniqueItems.filter(i => i.toLowerCase().includes(query));
        renderItemList(filtered);
      }
      // Clean selected items using Pyodide (pandas)
      async function cleanSelected() {
        const file = fullFileBuffer;
        if (!file) {
          alert('Please upload and scan a file first');
          return;
        }
        const selectEl = document.getElementById('item-list');
        const selected = Array.from(selectEl.selectedOptions).map(opt => opt.value);
        if (selected.length === 0) {
          alert('Please select at least one item number to clean');
          return;
        }
        await ensurePyodide();
        updateStatus('Running Python cleaning script…');
        // Define Python code to clean selected items
        const code = `import pandas as pd, io, json\n` +
          `data_bytes = bytes(data_bytes)\n` +
          `df = pd.read_excel(io.BytesIO(data_bytes))\n` +
          `# Normalize column names\n` +
          `df.columns = [str(c).strip() for c in df.columns]\n` +
          `# Rename columns heuristically if needed\n` +
          `mapping = {\n` +
          `    'Item No': 'Item No',\n` +
          `    'Document Name': 'Document Name',\n` +
          `    'File Path': 'File Path',\n` +
          `    'Document Type Group': 'Document Type Group',\n` +
          `    'Date Stored': 'Date Stored',\n` +
          `    'Document Type': 'Document Type'\n` +
          `}\n` +
          `df = df.rename(columns={c: mapping.get(c, c) for c in df.columns})\n` +
          `# Ensure string type and strip whitespace\n` +
          `for col in df.columns:\n` +
          `    df[col] = df[col].astype(str).str.strip()\n` +
          `selected = json.loads(selected_json)\n` +
          `df = df[df['Item No'].isin(selected)]\n` +
          `grouped = (df.groupby(['Item No','Document Name','Document Type Group','Date Stored','Document Type'], as_index=False)\n` +
          `             .agg({'File Path': lambda x: '; '.join(sorted(set(x)))})\n` +
          `            )\n` +
          `result = grouped.to_dict(orient='records')\n`;
        try {
          const result = await pyodideInstance.runPythonAsync(code, {
            data_bytes: file,
            selected_json: JSON.stringify(selected)
          });
          // convert Python list of dicts to JS array
          cleanedData = result.toJs();
          renderResults(cleanedData);
          document.getElementById('download-btn').disabled = false;
          updateStatus('Cleaning complete. Found ' + cleanedData.length + ' records');
        } catch (err) {
          console.error(err);
          updateStatus('Python error: ' + err);
        }
      }
      // Render cleaned results into the table
      function renderResults(data) {
        const headerEl = document.getElementById('results-header');
        const bodyEl = document.getElementById('results-body');
        headerEl.innerHTML = '';
        bodyEl.innerHTML = '';
        if (!data || data.length === 0) {
          return;
        }
        // Determine columns from first record
        const cols = Object.keys(data[0]);
        for (const col of cols) {
          const th = document.createElement('th');
          th.textContent = col;
          headerEl.appendChild(th);
        }
        for (const row of data) {
          const tr = document.createElement('tr');
          for (const col of cols) {
            const td = document.createElement('td');
            td.textContent = row[col];
            tr.appendChild(td);
          }
          bodyEl.appendChild(tr);
        }
      }
      // Filter cleaned results based on search input
      function filterResults() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const filtered = cleanedData.filter(row => {
          return Object.values(row).some(val => val.toLowerCase().includes(query));
        });
        renderResults(filtered);
      }
      // Download cleaned data as zipped Excel file
      async function downloadCleaned() {
        if (!cleanedData || cleanedData.length === 0) {
          alert('No cleaned data to download');
          return;
        }
        updateStatus('Preparing download…');
        // Convert cleanedData to worksheet and workbook
        const worksheet = XLSX.utils.json_to_sheet(cleanedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, worksheet, 'Cleaned');
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        // Zip using JSZip
        const zip = new JSZip();
        zip.file('cleaned.xlsx', wbout);
        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cleaned.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        updateStatus('Download ready');
      }
    </script>
  </body>
</html>
